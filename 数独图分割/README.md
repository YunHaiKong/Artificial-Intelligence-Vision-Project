# 数独图分割系统

## 项目概述

本项目实现了一个完整的数独图分割系统，能够自动识别图像中的数独网格，并将其分割为81个独立的单元格。系统基于OpenCV计算机视觉技术，支持处理包含多个数独网格的图像，并能自动保存分割结果。

## 功能特点

- **多网格识别**：自动检测图像中的多个数独网格
- **精确分割**：将每个数独网格精确分割为9×9=81个单元格
- **透视矫正**：自动矫正倾斜的数独图像
- **可视化展示**：实时显示每个处理步骤的结果
- **自动保存**：自动保存分割后的数独大图和单元格图像

## 技术实现流程

### 1. 图像预处理
- 读取灰度图像
- 高斯模糊去噪
- 自适应阈值分割
- 形态学膨胀操作

### 2. 数独网格检测
- 轮廓检测算法
- 多边形近似筛选
- 矩形轮廓识别
- 多网格定位

### 3. 透视变换
- 角点检测与排序
- 透视变换矩阵计算
- 图像矫正
- 标准化输出

### 4. 网格分割
- 9×9网格推断
- 单元格精确定位
- 数字特征提取
- 图像标准化

### 5. 结果展示
- 81个单元格可视化
- 网格编号显示
- 自动保存结果
- 时间戳命名

## 核心函数说明

### 图像处理函数
- `show_image(img, win='image')` - 显示图像
- `show_digits(digits, color=255, withBorder=True, grid_num=1)` - 显示81个数字单元格
- `pre_process_gray(gray, skip_dilate=False)` - 灰度图像预处理

### 几何变换函数
- `find_corners_of_largest_polygon(bin_img)` - 寻找最大多边形的角点
- `crop_and_warp(gray, crop_rect)` - 裁剪和透视变换
- `infer_grid(square_gray)` - 推断9×9网格

### 特征提取函数
- `extract_digit(bin_img, rect, size)` - 提取数字特征
- `find_largest_feature(inp_img, scan_tl, scan_br)` - 寻找最大特征
- `scale_and_centre(img, size, margin=0, background=0)` - 缩放和居中

### 多网格处理函数
- `find_sudoku_grids(image_path)` - 查找所有数独网格
- `parse_multiple_grids(image_path)` - 处理多个数独网格
- `order_points(pts)` - 角点排序

## 文件结构

```
数独图分割/
├── 数独图分割.py              # 主程序文件
├── sudoku2.png                # 测试图像（包含多个数独网格）
├── segmentedBigImg_grid1_*.jpg # 自动保存的数独大图
├── segmentedBigImg_grid2_*.jpg # 多个网格的保存文件
├── cropped_grid_*.png         # 裁剪后的数独图像
└── README.md                  # 项目说明文档
```

## 环境要求

### 必备依赖
```bash
pip install opencv-python
pip install numpy
pip install matplotlib
```

### 推荐版本
- Python 3.7+
- OpenCV 4.5+
- NumPy 1.19+

## 使用方法

### 运行方式

1. **直接运行：**
   ```bash
   python 数独图分割.py
   ```

2. **自定义图像：**
   - 修改代码中的 `image_path` 变量
   - 确保图像包含清晰的数独网格

### 处理流程

1. **图像加载**：自动加载测试图像 `sudoku2.png`
2. **网格检测**：检测图像中的所有数独网格
3. **透视矫正**：对每个网格进行透视变换矫正
4. **网格分割**：将每个网格分割为81个单元格
5. **结果展示**：显示分割结果并自动保存

## 核心算法

### 轮廓检测算法
- 使用OpenCV的findContours函数
- 基于多边形近似筛选矩形轮廓
- 支持多网格检测

### 透视变换算法
- 使用getPerspectiveTransform和warpPerspective
- 自动角点排序（左上、右上、右下、左下）
- 标准化输出正方形图像

### 网格分割算法
- 等分法推断9×9网格
- 精确计算每个单元格位置
- 支持多网格并行处理

### 特征提取算法
- 洪水填充算法识别数字区域
- 边界框计算和特征缩放
- 图像标准化处理

## 项目亮点

1. **多网格支持**：能够处理包含多个数独网格的图像
2. **自动矫正**：自动矫正倾斜的数独图像
3. **精确分割**：高精度的9×9网格分割
4. **可视化调试**：完整的处理流程可视化
5. **自动保存**：时间戳命名的自动保存功能

## 扩展应用

- 可扩展支持不同尺寸的数独网格
- 可集成数字识别算法
- 可支持在线数独游戏
- 可添加批量处理功能

## 技术细节

### 图像预处理
- 高斯模糊：9×9内核
- 自适应阈值：11×11邻域，偏移量2
- 形态学膨胀：3×3十字形内核

### 网格检测
- 轮廓面积排序
- 多边形近似精度：2%
- 矩形轮廓筛选

### 透视变换
- 浮点精度坐标转换
- 标准化正方形输出
- 保持原始比例

## 许可证

本项目仅用于学习和教育目的。