# 车道线检测与绘制系统

## 项目概述

本项目实现了一个完整的车道线检测与绘制系统，能够自动识别道路图像中的左右车道线，并进行精确的拟合和可视化。系统基于OpenCV计算机视觉技术，结合霍夫变换和最小二乘法拟合，实现了高精度的车道线检测。

## 功能特点

- **交互式ROI选择**：支持鼠标交互选择感兴趣区域
- **颜色空间过滤**：基于HSV颜色空间精确提取白色和黄色车道线
- **边缘检测**：使用Canny算法检测车道线边缘
- **霍夫变换**：检测图像中的直线段
- **斜率过滤**：过滤异常线段，保留有效车道线
- **最小二乘法拟合**：将多个线段拟合成单一车道线
- **实时可视化**：完整展示每个处理步骤的结果

## 技术实现流程

### 1. 图像预处理
- 读取原始道路图像
- 交互式ROI区域选择
- HSV颜色空间转换
- 白色和黄色车道线提取

### 2. 边缘检测
- 灰度图像转换
- 高斯模糊去噪
- Canny边缘检测
- ROI掩码应用

### 3. 车道线检测
- 霍夫变换直线检测
- 基于斜率分类左右车道线
- 异常线段剔除
- 最小二乘法拟合

### 4. 结果可视化
- 拟合车道线绘制
- 处理过程可视化
- 最终结果展示

## 核心函数说明

### 图像显示函数
- `cv2show(img, title='img')` - 使用OpenCV显示图像
- `pltshow(img, title=None, hideTicks=True)` - 使用Matplotlib显示图像

### 交互式ROI选择
- `get_points(im, title="选择ROI区域")` - 鼠标交互选择ROI区域
- `mouse_handler(event, x, y, flags, data)` - 鼠标事件回调函数

### 颜色空间处理
- `select_white_yellow(color_img)` - 提取白色和黄色车道线
- 基于HSV颜色空间的精确阈值分割

### 边缘检测函数
- `get_edge_img(color_img, gaussian_ksize=5, canny_threshold_low=1, canny_threshold_high=120)` - 获取边缘图像
- 包含颜色过滤、灰度化、高斯模糊和Canny边缘检测

### 几何处理函数
- `calculate_slope(line)` - 计算线段斜率
- `roi_mask(gray_img, ROIL_vertices, ROIR_vertices)` - 应用ROI掩码
- `reject_abnormal_lines(lines, threshold=0.1)` - 剔除异常线段

### 拟合算法函数
- `least_squares_fit(lines)` - 最小二乘法拟合线段
- `get_lines(edge_img)` - 获取所有线段并分类拟合
- `draw_lines2(img, lines, pos=True, color=[255, 0, 0], thickness=10)` - 绘制车道线

## 文件结构

```
绘制车道线/
├── 绘制车道线.ipynb          # 主程序文件（Jupyter Notebook）
├── test.jpg                  # 测试图像
├── 处理结果图像/              # 自动保存的处理结果
│   ├── 原始图像.jpg
│   ├── ROI区域.jpg
│   ├── 颜色过滤结果.jpg
│   ├── 边缘检测结果.jpg
│   ├── 车道线检测结果.jpg
│   └── 最终结果.jpg
└── README.md                 # 项目说明文档
```

## 环境要求

### 必备依赖
```bash
pip install opencv-python
pip install numpy
pip install matplotlib
```

### 推荐版本
- Python 3.7+
- OpenCV 4.5+
- NumPy 1.19+
- Matplotlib 3.3+

## 使用方法

### 运行方式

1. **Jupyter Notebook运行：**
   ```bash
   jupyter notebook
   # 打开 绘制车道线.ipynb 文件
   # 按顺序运行所有代码单元格
   ```

2. **自定义图像：**
   - 修改代码中的图像路径
   - 确保图像包含清晰的车道线

### 交互式操作流程

1. **ROI区域选择：**
   - 左键点击添加点（至少3个点）
   - 右键双击完成选择
   - 系统自动绘制多边形并填充

2. **处理步骤：**
   - 自动进行颜色空间过滤
   - 边缘检测和ROI掩码
   - 霍夫变换直线检测
   - 车道线拟合和绘制

## 核心算法

### HSV颜色空间过滤
- 白色车道线：H[0,180], S[0,30], V[221,255]
- 黄色车道线：H[26,34], S[43,255], V[46,255]
- 使用cv2.inRange函数进行阈值分割

### Canny边缘检测
- 高斯模糊核大小：5×5
- 低阈值：1
- 高阈值：120
- 自动边缘连接

### 霍夫变换参数
- 距离分辨率：1像素
- 角度分辨率：π/180弧度
- 阈值：20
- 最小线段长度：1像素
- 最大线段间隔：90像素

### 斜率过滤算法
- 左车道线斜率：-0.96 < slope < -0.35
- 右车道线斜率：0.35 < slope < 0.96
- 异常斜率阈值：0.1

### 最小二乘法拟合
- 一次多项式拟合（直线）
- 基于所有有效线段的端点坐标
- 自动计算最小和最大x坐标对应的y值

## 项目亮点

1. **交互式操作**：支持鼠标交互选择ROI区域
2. **颜色空间优化**：基于HSV空间的精确颜色过滤
3. **鲁棒性检测**：多重过滤机制确保检测准确性
4. **实时可视化**：完整的处理流程可视化展示
5. **参数可调**：所有关键参数均可根据实际情况调整

## 扩展应用

- 可扩展支持视频流处理
- 可集成深度学习模型
- 可添加车道偏离预警功能
- 可支持多种道路场景
- 可添加实时处理功能

## 技术细节

### 图像预处理参数
- 高斯模糊：5×5内核
- HSV颜色空间转换
- 位运算掩码应用

### 边缘检测参数
- Canny低阈值：1
- Canny高阈值：120
- 自动边缘连接

### 霍夫变换参数
- 距离分辨率：1像素
- 角度分辨率：π/180弧度
- 最小线段长度：1像素
- 最大线段间隔：90像素

### 拟合算法
- 一次多项式最小二乘拟合
- 自动端点计算
- 整数坐标转换

## 许可证

本项目仅用于学习和教育目的。